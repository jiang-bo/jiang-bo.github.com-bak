<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: JVM | Jiang Bo]]></title>
  <link href="http://jiang-bo.github.com/blog/categories/jvm/atom.xml" rel="self"/>
  <link href="http://jiang-bo.github.com/"/>
  <updated>2012-02-13T17:05:39+08:00</updated>
  <id>http://jiang-bo.github.com/</id>
  <author>
    <name><![CDATA[jiangbo]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[CentOS6编译OpenJDK7]]></title>
    <link href="http://jiang-bo.github.com/blog/2012/02/10/compile-openjdk7-on-centos6/"/>
    <updated>2012-02-10T14:39:00+08:00</updated>
    <id>http://jiang-bo.github.com/blog/2012/02/10/compile-openjdk7-on-centos6</id>
    <content type="html"><![CDATA[<h2>一.环境准备</h2>

<h3>1.jdk</h3>

<p>在编译JDK7之前，需要有个JDK6版本，这个貌似有个鸡生蛋，还是蛋生鸡的问题，不过，这个确实需要:)</p>

<h3>2.alsa包</h3>

<p>linux版本的jdk编译需要ALSA（Advanced Linux Sound Architecture）包，大部分linux发行版都没有预装，CentOS可以通过如下命令检查：</p>

<pre><code> rpm -qa |grep alsa
</code></pre>

<p>alsa-lib和alsa-lib-devel均需要。CentOS缺少alsa-lib-devel，通过如下命令安装：</p>

<pre><code> yum install alsa-lib-devel
</code></pre>

<h3>3.cups-devel</h3>

<pre><code>yum install cups-devel
</code></pre>

<h3>4.libXi-devel</h3>

<pre><code>yum install libXi-devel
</code></pre>

<h3>5.freetype2.3</h3>

<pre><code>wget http://download.savannah.gnu.org/releases/freetype/freetype-2.3.12.tar.gz
tar -xvf freetype-2.3.12.tar.gz
cd freetype-2.3.12
./configure &amp;&amp; make &amp;&amp; make install
</code></pre>

<h3>6. ant</h3>

<pre><code>wget http://mirror.bit.edu.cn/apache//ant/binaries/apache-ant-1.8.2-bin.zip
unzip apache-ant-1.8.2-bin.zip
</code></pre>

<h3>7.g++</h3>

<pre><code>yum install gcc gcc-c++
</code></pre>

<h2>二、设置环境变量</h2>

<p>jdk编译过程中有一些环境变量需要设置，详细的请参考README-builds.html，下面写的只是一些必须设置的环境变量：</p>

<pre><code>export ALT_BOOTDIR=/usr/opt/jdk # 预装的jdk7目录
export ANT_HOME=ant安装目录
export ALT_FREETYPE_HEADERS_PATH=/usr/local/include/freetype2 #freetype2头文件安装目录
export ALT_FREETYPE_LIB_PATH=/usr/local/lib #freetype2 lib目录
</code></pre>

<h2>三、编译</h2>

<h3>1.健全检查</h3>

<p>可以通过如下命令检查环境配置是否准备好：</p>

<pre><code>make sanity ARCH_DATA_MODEL=64
</code></pre>

<p>如果最终输出：</p>

<pre><code>Sanity check passed.
</code></pre>

<p>则表示环境检查通过，否则需要根据提示信息排查问题。</p>

<h3>2.执行编译</h3>

<p>通过如下命令开始编译：</p>

<pre><code>make ARCH_DATA_MODEL=64
</code></pre>

<h3>3.问题排查：</h3>

<p>编译过程中出现一些问题：</p>

<h3>1)缺少jaxp和jaxws</h3>

<p>错误信息</p>

<pre><code>ERROR: Cannot find source for project jaxp
</code></pre>

<p>原因是现在jaxp源码分支和jdk源码分支分开了，但是jaxws是jdk中的一部分，所以完全编译需要jaxp源码，针对该问题的描述可以查看README-build.html中TroubleShooting部分。
解决方式有两种：
一种是先下载好源码包，以drops的方式安装，具体参考README-build.html
另外一种是使用在线安装，在编译时加入允许下载源码的配置:</p>

<pre><code>make ARCH_DATA_MODEL=64 ALLOW_DOWNLOADS=true
</code></pre>

<h3>2)缺少X＊库</h3>

<p>编译过程中多次出现如下缺少X*, awt之类的错误，基本上都是因为缺乏图形相关的库</p>

<pre><code>../../../src/solaris/native/sun/awt/img_util_md.h:32: ??:expected specifier-qualifier-list before 'XID'
make[5]: *** [/home/jiangbo/Workspace/jdk/openjdk/build/linux-amd64/tmp/sun/sun.awt/awt/obj64/BufImgSurfaceData.o] Error 1
make[5]: *** Waiting for unfinished jobs....
make[5]: Leaving directory `/home/jiangbo/Workspace/jdk/openjdk/jdk/make/sun/awt'
make[4]: *** [library_parallel_compile] Error 2
make[4]: Leaving directory `/home/jiangbo/Workspace/jdk/openjdk/jdk/make/sun/awt'
make[3]: *** [all] Error 1
make[3]: Leaving directory `/home/jiangbo/Workspace/jdk/openjdk/jdk/make/sun'
make[2]: *** [all] Error 1
make[2]: Leaving directory `/home/jiangbo/Workspace/jdk/openjdk/jdk/make'
make[1]: *** [jdk-build] Error 2
make[1]: Leaving directory `/home/jiangbo/Workspace/jdk/openjdk'
make: *** [build_product_image] Error 2
</code></pre>

<p>解决方式时安装X相关的库</p>

<pre><code>yum install libX*
</code></pre>

<p>这个有些暴力，不过比较有效:)</p>

<h2>四、测试编译结果</h2>

<p>漫长的编译之后直至出现如下类似内容时，表示编译完成了：</p>

<pre><code>-- Build times ----------
Target all_product_build
Start 2012-02-09 10:38:39
End   2012-02-09 11:14:37
00:01:41 corba
00:06:19 hotspot
00:15:49 jaxp
00:01:30 jaxws
00:10:03 jdk
00:00:36 langtools
00:35:58 TOTAL
</code></pre>

<p>编译完成后，编译结果维语build/linux-amd64目录下，可以写个简单的Java程序测试编译结果</p>

<p>Test.java</p>

<pre><code>public class Test{
        public static void main(String[] args){
                System.out.println("Hello");
        }
}
</code></pre>

<p>编译</p>

<pre><code>[root@localhost openjdk]# ./build/linux-amd64/bin/java Test.java
</code></pre>

<p>执行</p>

<pre><code>[root@localhost openjdk]# ./build/linux-amd64/bin/java Test
Hello
</code></pre>
]]></content>
  </entry>
  
</feed>
